<script>
    // ... (Engine and UI Logic Preserved) ...

    function onGooglePayLoaded() {
        const paymentsClient = new google.payments.api.PaymentsClient({
            environment: 'TEST' // Change to 'PRODUCTION' when ready
        });

        const button = paymentsClient.createButton({
            buttonColor: 'black',
            buttonType: 'buy',
            onClick: () => {
                const paymentDataRequest = {
                    apiVersion: 2,
                    apiVersionMinor: 0,
                    allowedPaymentMethods: [{
                        type: 'CARD',
                        parameters: {
                            allowedAuthMethods: ["PAN_ONLY", "CRYPTOGRAM_3DS"],
                            allowedCardNetworks: ["VISA", "MASTERCARD"]
                        },
                        tokenizationSpecification: {
                            type: 'PAYMENT_GATEWAY',
                            parameters: {
                                'gateway': 'example',
                                'gatewayMerchantId': 'exampleGatewayMerchantId'
                            }
                        }
                    }],
                    transactionInfo: {
                        totalPriceStatus: 'FINAL',
                        totalPrice: ENGINE.total.toString(),
                        currencyCode: 'ZAR',
                        countryCode: 'ZA'
                    },
                    merchantInfo: {
                        merchantName: 'Otaku Beads'
                    }
                };

                // HEAVY LIFTING: Only send WhatsApp if Google Pay clears
                paymentsClient.loadPaymentData(paymentDataRequest)
                    .then(function(paymentData) {
                        console.log("Payment Success Anchor âš“");
                        ENGINE.sendWhatsApp(paymentData); 
                    })
                    .catch(function(err) {
                        console.error("Payment Failed", err);
                        alert("Payment was not completed. Please try again.");
                    });
            }
        });
        document.getElementById('gpay-area').appendChild(button);
    }

    ENGINE.sendWhatsApp = function(paymentData) {
        const user = JSON.parse(localStorage.getItem('user')) || {name: "Guest Customer"};
        let list = "";
        for(let n in this.cart) {
            list += `ðŸ“¦ ${n.split('.')[0]} (x${this.cart[n].qty})\n`;
        }
        
        const msg = `âš“ *OTAKU BEADS: PAID ORDER*\n\n` +
                    `*Status:* Payment Authorized via GPay\n` +
                    `*Customer:* ${user.name}\n` +
                    `*Items:*\n${list}\n` +
                    `*Delivery:* ${this.paxiName}\n` +
                    `*Total Paid:* R${this.total}\n\n` +
                    `*GPay Ref:* ${paymentData.paymentMethodData.description}`;

        window.open(`https://wa.me/27663443753?text=${encodeURIComponent(msg)}`);
    };
</script>
